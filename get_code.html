<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>获取Ticket Code</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        neutral: '#6B7280',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .input-focus {
                @apply focus:ring-2 focus:ring-primary/50 focus:border-primary focus:outline-none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-white rounded-xl p-6 card-shadow transition-all duration-300 hover:shadow-lg">
        <div class="text-center mb-6">
            <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-gray-800">获取 Ticket Code</h1>
            <p class="text-neutral mt-2">输入AppKey，点击按钮获取对应的Code</p>
        </div>
        
        <div class="space-y-5">
            <!-- AppKey 输入区域 -->
            <div>
                <label for="appkey" class="block text-sm font-medium text-gray-700 mb-1">AppKey</label>
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-neutral">
                        <i class="fa fa-key"></i>
                    </span>
                    <input 
                        type="text" 
                        id="appkey" 
                        placeholder="请输入你的AppKey" 
                        class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg input-focus transition-all"
                    >
                </div>
            </div>
            
            <!-- 操作按钮 -->
            <button 
                onclick="handleGetCode()" 
                class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center justify-center gap-2"
            >
                <i class="fa fa-qrcode"></i>
                <span>获取 Code</span>
            </button>
            
            <!-- 分隔线 -->
            <div class="relative">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-gray-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-gray-500">结果</span>
                </div>
            </div>
            
            <!-- Code 输出区域 -->
            <div>
                <label for="code" class="block text-sm font-medium text-gray-700 mb-1">获取到的 Code</label>
                <div class="relative">
                    <textarea 
                        id="code" 
                        rows="3" 
                        placeholder="获取的Code将显示在这里..." 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg input-focus transition-all resize-none bg-gray-50"
                        readonly
                    ></textarea>
                    <button 
                        onclick="copyToClipboard()" 
                        class="absolute right-2 bottom-2 text-neutral hover:text-primary transition-colors"
                        title="复制到剪贴板"
                    >
                        <i class="fa fa-copy"></i>
                    </button>
                </div>
                <p id="copyStatus" class="text-xs text-gray-500 mt-1 hidden"></p>
            </div>
            
            <!-- 状态提示区域 -->
            <div id="statusMessage" class="hidden p-3 rounded-lg text-sm"></div>
        </div>
    </div>

    <script>
        // 处理获取Code的逻辑
        function handleGetCode() {
            const appkeyInput = document.getElementById('appkey');
            const appkey = appkeyInput.value.trim();
            
            // 验证输入
            if (!appkey) {
                showMessage('请输入AppKey', 'error');
                appkeyInput.focus();
                return;
            }
            
            // 显示加载状态
            showMessage('正在获取Code...', 'info');
            document.getElementById('code').value = '';
            
            // 调用原生App接口
            test(appkey);
        }
        
        // 根据环境调用原生App的接口
        function test(appkey) {
            try {
                if (window.java) {
                    // Android环境
                    window.java.onClickGetTicket(appkey);
                } else if (window.webkit?.messageHandlers?.onClickGetTicket) {
                    // iOS环境
                    window.webkit.messageHandlers.onClickGetTicket.postMessage(appkey);
                } else {
                    // 测试模式：如果没有检测到App环境，使用模拟数据
                    setTimeout(() => {
                        getTicket(`模拟环境：AppKey=${appkey}，Code=TEST-${Math.random().toString(36).substr(2, 10).toUpperCase()}`);
                    }, 1000);
                }
            } catch (error) {
                showMessage(`调用出错：${error.message}`, 'error');
            }
        }
        
        // 接收信息并显示
        function getTicket(info) {
            const codeOutput = document.getElementById('code');
            codeOutput.value = info;
            
            // 尝试从info中提取code（根据实际返回格式调整）
            let code = info;
            if (info.includes('code=')) {
                const match = info.match(/code=([^,]+)/);
                if (match && match[1]) {
                    code = match[1];
                    codeOutput.value = code;
                }
            }
            
            showMessage('成功获取Code', 'success');
            
            // 自动选中输出区域便于复制
            codeOutput.select();
        }
        
        // 复制到剪贴板功能
        function copyToClipboard() {
            const codeOutput = document.getElementById('code');
            const copyStatus = document.getElementById('copyStatus');
            
            if (!codeOutput.value) {
                return;
            }
            
            navigator.clipboard.writeText(codeOutput.value)
                .then(() => {
                    copyStatus.textContent = '已复制到剪贴板';
                    copyStatus.classList.remove('hidden', 'text-red-500');
                    copyStatus.classList.add('text-green-500');
                    
                    setTimeout(() => {
                        copyStatus.classList.add('hidden');
                    }, 2000);
                })
                .catch(err => {
                    copyStatus.textContent = '复制失败，请手动复制';
                    copyStatus.classList.remove('hidden', 'text-green-500');
                    copyStatus.classList.add('text-red-500');
                });
        }
        
        // 显示状态消息
        function showMessage(text, type = 'info') {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = text;
            statusEl.classList.remove('hidden', 'bg-blue-50', 'text-blue-700', 'bg-green-50', 'text-green-700', 'bg-red-50', 'text-red-700');
            
            switch(type) {
                case 'info':
                    statusEl.classList.add('bg-blue-50', 'text-blue-700');
                    break;
                case 'success':
                    statusEl.classList.add('bg-green-50', 'text-green-700');
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-50', 'text-red-700');
                    break;
            }
            
            // 3秒后自动隐藏成功和信息提示
            if (type !== 'error') {
                setTimeout(() => {
                    statusEl.classList.add('hidden');
                }, 3000);
            }
        }
    </script>
</body>
</html>
